<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Routine Matinale</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f7f7f7;
    }
    h1 {
      font-size: 5rem;
      margin: 20px 0;
    }
    h2 {
      font-size: 3rem;
      margin: 10px 0;
    }
    .time {
      font-size: 8rem;
      margin: 20px 0;
    }
    p {
      font-size: 2.5rem;
    }
    button {
      padding: 10px 20px;
      font-size: 1.5rem;
      margin-top: 20px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    #mute-icon {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<h1>Routine Matinale</h1>
<div class="time" id="time">00:00</div>
<h2 id="step" style="display: none;">√âtape : Prendre la pilule</h2>
<p id="step-timing" style="display: none;">Temps recommand√© : 6:55 - 7:00</p>
<button id="mute-toggle">
  <span id="mute-icon">üîä</span> Activer le son
</button>

<button id="toggle-test-settings" style="position: absolute; top: 10px; right: 10px;">Tests</button>
<div id="test-settings" style="display: none;">
  <input type="time" id="custom-time" step="60">
  <button id="set-custom-time">D√©finir l'heure</button>
  <button id="reset-custom-time">R√©initialiser l'heure</button>
  <p id="custom-time-indicator" style="display: none; color: blue;">Mode heure personnalis√©e activ√©</p>
</div>

<script>
  const steps = [
    { name: "Prendre la pilule", timings: [420, 425, 425], recommended: "6:55 - 7:00" },
    { name: "Manger", timings: [430, 435, 435], recommended: "7:00 - 7:10" },
    { name: "Habiller", timings: [435, 440, 440], recommended: "7:10 - 7:15" },
    { name: "Dents", timings: [440, 445, 450], recommended: "7:15 - 7:20" },
    { name: "Habillage pour dehors", timings: [450, 450, 450], recommended: "7:20 - 7:30" }
  ];

  let currentStepIndex = 0;

  const audio = new Audio("https://www.soundjay.com/button/beep-07.wav");
  const notificationAudio = new Audio("https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3");
  let isMuted = JSON.parse(localStorage.getItem('isMuted')) || false;

  const muteButton = document.getElementById('mute-toggle');
  const muteIcon = document.getElementById('mute-icon');
  const testModeButton = document.getElementById('test-mode-toggle');
  const stepElement = document.getElementById('step');
  const customTimeInput = document.getElementById('custom-time');
  const setCustomTimeButton = document.getElementById('set-custom-time');
  let customTime = null;
  const stepTimingElement = document.getElementById('step-timing');
  const resetCustomTimeButton = document.getElementById('reset-custom-time');
  const customTimeIndicator = document.getElementById('custom-time-indicator');

  function updateMuteButton() {
    muteButton.textContent = isMuted ? ' Activer le son' : ' Couper le son';
    muteIcon.textContent = isMuted ? 'üîá' : 'üîä';
    muteButton.prepend(muteIcon);
  }



  // Toggle mute/unmute
  muteButton.addEventListener('click', () => {
    isMuted = !isMuted;
    localStorage.setItem('isMuted', JSON.stringify(isMuted));
    updateMuteButton();
  });

  // Update the current time every second
  function updateTime() {
    let now = new Date();
    let hours, minutes;
    if (customTime) {
      if (customTime.includes(':')) {
        [hours, minutes] = customTime.split(':').map(Number);
      } else {
        hours = now.getHours();
        minutes = now.getMinutes();
      }
    } else {
      hours = now.getHours();
      minutes = now.getMinutes();
    }
    const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    const currentTime = hours * 60 + minutes;


    if (currentTime >= 390 && currentTime <= 460) { // Routine hours or test mode
      document.getElementById('time').textContent = formattedTime;
      stepElement.style.display = "block";
      stepTimingElement.style.display = "block";
      updateStepColor(currentTime);
      updateTimeColor(currentTime);
    } else {
      document.getElementById('time').textContent = `${formattedTime} - Routine termin√©e`;
      if (document.getElementById('bravo-message')) {
        document.getElementById('bravo-message').remove();
      }
      document.getElementById('time').style.color = "black";
      stepElement.style.display = "none";
      stepTimingElement.style.display = "none";
    }
  }

  // Determine the color for the current step
  function updateStepColor(currentTime) {
    const step = steps[currentStepIndex];
    const [greenTime, yellowTime, redTime] = step.timings;
    let color = "";

    if (currentTime < greenTime) {
      color = "green";
    } else if (currentTime < yellowTime) {
      color = "#f29913";
    } else {
      if (!isMuted && document.getElementById('step').style.color !== "red") {
        notificationAudio.play();
      }
      color = "#b22222";
    }

    document.getElementById('step').style.color = color;
  }

  document.addEventListener('keydown', (event) => {
    const bravoMessage = document.getElementById('bravo-message') || document.createElement('p');
    bravoMessage.id = 'bravo-message';
    bravoMessage.style.fontSize = '3rem';
    bravoMessage.style.color = 'green';
    bravoMessage.textContent = 'Bravo, la routine est termin√©e dans les temps !';

    if (event.code === 'Space') {
      if (!isMuted) audio.play();

      const currentStep = steps[currentStepIndex];
      const now = new Date();
      const currentTime = (customTime ? customTime.split(':').map(Number)[0] * 60 + customTime.split(':').map(Number)[1] : now.getHours() * 60 + now.getMinutes());
      const isLastStep = currentStepIndex === steps.length - 1;
      const completedInGreen = currentTime < currentStep.timings[1];

      if (isLastStep && completedInGreen) {
        stepElement.textContent = 'Bravo, la routine est termin√©e dans les temps !';
        stepTimingElement.textContent = '';
        stepElement.style.color = 'green';
        stepElement.style.display = 'block';
      }
      
      if (!isLastStep) {
        currentStepIndex++;
        document.getElementById('step').textContent = `√âtape : ${steps[currentStepIndex].name}`;
        document.getElementById('step-timing').textContent = `Temps recommand√© : ${steps[currentStepIndex].recommended}`;
      }
    }
  });

  setInterval(updateTime, 1000);

  document.getElementById('toggle-test-settings').addEventListener('click', () => {
    const testSettings = document.getElementById('test-settings');
    testSettings.style.display = testSettings.style.display === 'none' ? 'block' : 'none';
  });

  resetCustomTimeButton.addEventListener('click', () => {
    customTime = null;
    localStorage.removeItem('customTime');
    customTimeInput.value = '';
    customTimeIndicator.style.display = 'none';
    updateTime();
  });

  customTime = localStorage.getItem('customTime');
  if (customTime) {
    customTimeIndicator.style.display = 'block';
  }

  setCustomTimeButton.addEventListener('click', () => {
    customTime = customTimeInput.value;
    localStorage.setItem('customTime', customTime);
    customTimeIndicator.style.display = 'block';
    updateTime();
  });
  updateMuteButton();
</script>
</body>
</html>
